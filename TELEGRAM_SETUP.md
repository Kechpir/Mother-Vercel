# Инструкция по настройке Telegram группы и одноразовых ссылок

## Шаг 1: Создание Telegram бота

1. Открой Telegram и найди **@BotFather**
2. Отправь команду `/newbot`
3. Следуй инструкциям и создай бота
4. **Сохрани токен бота** (выглядит как `123456789:ABCdefGHIjklMNOpqrsTUVwxyz`)

## Шаг 2: Создание закрытой группы

1. Создай новую группу в Telegram
2. Назови её (например, "Энергетические сессии - Закрытая группа")
3. Сделай группу **приватной** (Settings → Group Type → Private)
4. Добавь созданного бота в группу
5. Сделай бота **администратором** группы:
   - Settings → Administrators → Add Administrator
   - Выбери бота
   - Дай ему права: "Invite Users via Link" (обязательно!)

## Шаг 3: Получение ID группы

1. Добавь в группу бота **@userinfobot**
2. Отправь команду `/start` в группе
3. Бот покажет ID группы (выглядит как `-1001234567890`)
4. **Сохрани этот ID** (он начинается с `-100`)

## Шаг 4: Обновление базы данных

Выполни SQL скрипт `supabase_telegram_setup.sql` в Supabase SQL Editor:
- Открой Supabase Dashboard → SQL Editor
- Скопируй содержимое файла `supabase_telegram_setup.sql`
- Выполни скрипт

## Шаг 5: Настройка переменных окружения

Добавь в Vercel Environment Variables:

```
TELEGRAM_BOT_TOKEN=твой_токен_бота
TELEGRAM_GROUP_ID=твой_id_группы_с_минусом
SUPABASE_SERVICE_ROLE_KEY=твой_service_role_key_из_supabase
NEXT_PUBLIC_SITE_URL=https://energy-practice.org
```

**Где найти SUPABASE_SERVICE_ROLE_KEY:**
- Supabase Dashboard → Settings → API
- Скопируй "service_role" key (НЕ "anon" key!)

## Шаг 6: Настройка Robokassa

В настройках магазина Robokassa укажи:

**Result URL (для webhook):**
```
https://energy-practice.org/api/robokassa/webhook
```

**Success URL (куда вернуть пользователя после оплаты):**
```
https://energy-practice.org/success
```

**Метод отсылки данных:** `POST` (для Result URL)

## Шаг 7: Тестирование

1. Заполни форму регистрации на сайте
2. Оплати через Robokassa (тестовый режим)
3. После оплаты тебя должно перенаправить на `/success`
4. На странице успеха должна появиться ссылка на Telegram группу
5. Перейди по ссылке — должна открыться группа
6. Попробуй перейти по ссылке второй раз — должна быть ошибка (ссылка одноразовая)

## Важно!

- **Одноразовая ссылка** означает, что её можно использовать только **один раз**
- После использования ссылка становится недействительной
- Если пользователь случайно закрыл ссылку, нужно будет создать новую вручную через админ-панель (или добавить функционал для этого)

## Troubleshooting

**Проблема:** Ссылка не генерируется
- Проверь, что `TELEGRAM_BOT_TOKEN` правильный
- Проверь, что бот добавлен в группу как администратор
- Проверь, что у бота есть права "Invite Users via Link"

**Проблема:** Webhook не работает
- Проверь, что `ROBOKASSA_PASSWORD_2` правильный
- Проверь, что Result URL указан правильно в настройках Robokassa
- Проверь логи в Vercel (раздел Logs)

**Проблема:** Ссылка не одноразовая
- Убедись, что в коде `member_limit: 1` установлен
- Проверь, что используется правильный метод Telegram Bot API
