# Список задач (Backend & Frontend)

## Этап 1: Фундамент (Завершено)
- [x] Настроить переменные окружения (.env)
- [x] Инициализировать Next.js проект
- [x] Создать клиент Supabase для фронтенда
- [x] Настроить деплой на Vercel

## Этап 2: Лендинг и Дизайн (Завершено)
- [x] Перенос ассетов на Cloudinary
- [x] Верстка всех блоков по референсу (15+ блоков)
- [x] Реализация интерактивных элементов (Аккордеоны, Параллакс)
- [x] Создание адаптивного хедера и футера
- [x] Оптимизация масштаба (компактная версия)
- [x] Редизайн формы регистрации в темном стиле
- [x] Настройка юридических ссылок в футере

## Этап 3: Платежи через Robokassa (В процессе)

### 3.0 Система промокодов
- [ ] Создать таблицу `promo_codes` в Supabase:
  - `code` (text, unique) - код промокода
  - `discount_amount` (numeric) - сумма скидки в тенге
  - `discount_percent` (numeric, nullable) - процент скидки (альтернатива)
  - `is_active` (boolean, default: true)
  - `usage_limit` (integer, nullable) - лимит использований
  - `used_count` (integer, default: 0)
  - `expires_at` (timestamp, nullable)
  - `created_at` (timestamp)
- [ ] Добавить поле `promo_code` в форму регистрации
- [ ] Создать API route `/api/validate-promo` для проверки промокода
- [ ] Модифицировать `/api/create-payment`:
  - Принимать `promo_code` в запросе
  - Валидировать промокод (проверить в БД, активность, лимиты)
  - Рассчитывать финальную цену (25000 - discount или 15000 для промокодов)
  - Обновлять `used_count` после успешной оплаты
- [ ] Обновить форму регистрации:
  - Добавить поле ввода промокода
  - Показывать финальную цену после ввода промокода
  - Передавать промокод в API создания платежа
- [ ] Создать админ-панель для управления промокодами (опционально)

## Этап 3.1: Платежи через Kaspi Pay API (Отложено)

### 3.1 Подготовка и настройка Kaspi Pay
- [ ] Подать заявку на партнерство через kaspi.kz/webpay/partnership
- [ ] Получить API ключи (Client ID, Client Secret, Terminal ID)
- [ ] Получить доступ к тестовой среде для разработки
- [ ] Настроить переменные окружения в Vercel:
  - `KASPI_API_URL` (тестовый/боевой)
  - `KASPI_CLIENT_ID`
  - `KASPI_CLIENT_SECRET`
  - `KASPI_TERMINAL_ID`
  - `KASPI_WEBHOOK_SECRET`

### 3.2 Интеграция API в Next.js
- [ ] Создать API route `/api/kaspi/create-payment`:
  - Принимать данные из формы (имя, телефон, email, город)
  - Сохранять запись в Supabase со статусом `pending`
  - Создавать платеж через Kaspi Pay API
  - Возвращать ссылку/QR-код для оплаты
- [ ] Создать API route `/api/kaspi/webhook`:
  - Принимать webhook от Kaspi Pay
  - Проверять подпись запроса (безопасность)
  - Обновлять статус в Supabase (`pending` → `paid`)
  - Сохранять `payment_id` и `payment_date`
- [ ] Создать утилиту для работы с Kaspi Pay API:
  - Функция получения Bearer token (OAuth)
  - Функция создания платежа
  - Функция проверки статуса платежа

### 3.3 Обновление формы регистрации
- [ ] Модифицировать `handleSubmit` в `src/app/page.tsx`:
  - После сохранения данных в Supabase → вызывать `/api/kaspi/create-payment`
  - Получать ссылку/QR-код для оплаты
  - Редирект на страницу оплаты или показ QR-кода
- [ ] Добавить обработку ошибок при создании платежа

### 3.4 Страницы успеха и ошибки
- [ ] Создать страницу `/success`:
  - Показывать сообщение об успешной оплате
  - Предоставлять инструкции по получению доступа в Telegram группу
- [ ] Создать страницу `/error`:
  - Показывать сообщение об ошибке оплаты
  - Предлагать повторить попытку

### 3.5 Настройка Webhook в Kaspi Pay
- [ ] Указать URL webhook в настройках Kaspi Pay: `https://your-domain.vercel.app/api/kaspi/webhook`
- [ ] Протестировать получение webhook в тестовой среде
- [ ] Проверить обновление статусов в Supabase

## Этап 4: Telegram Группа и Доступ (Предстоит)

### 4.1 Создание закрытой Telegram группы
- [ ] Создать закрытую Telegram группу для оплативших участников
- [ ] Настроить права доступа (только админы могут добавлять участников)
- [ ] Настроить защиту контента:
  - Запрет копирования сообщений
  - Запрет пересылки сообщений
  - Автоматическое удаление нарушителей (если возможно)

### 4.2 Вариант А: Одноразовые инвайт-ссылки (рекомендуется)
- [ ] После успешной оплаты (webhook) генерировать одноразовую инвайт-ссылку
- [ ] Отправлять ссылку пользователю (email/SMS/на странице success)
- [ ] Отслеживать использование ссылок в БД (чтобы не повторно использовать)

### 4.3 Вариант Б: Минимальный Telegram бот (если нужна автоматизация)
- [ ] Создать минимальный бот через @BotFather
- [ ] Получить токен бота
- [ ] Реализовать логику добавления пользователей в группу:
  - После успешной оплаты (webhook) → бот добавляет пользователя по `telegram_username` или `phone_number`
  - Сохранять `telegram_user_id` в таблице `participants`
- [ ] Настроить бота как администратора группы

### 4.4 Ручное управление Zoom ссылками
- [ ] Создать Zoom конференцию вручную
- [ ] Отправить ссылку на Zoom один раз в Telegram группу
- [ ] Участники используют эту ссылку для доступа к сессиям
- **Примечание:** Автоматизация рассылок Zoom не требуется (делается вручную)

## Этап 5: Тестирование и Запуск (Предстоит)
- [ ] Протестировать полный цикл: форма → Kaspi Pay → оплата → webhook → обновление БД
- [ ] Протестировать одноразовые ссылки в Telegram (или работу бота)
- [ ] Проверить обработку ошибок (отмена оплаты, таймауты)
- [ ] Добавить логирование всех платежных операций
- [ ] Переключиться с тестовой среды на боевую в Kaspi Pay
- [ ] Финальное тестирование на production

## Технические детали

### Kaspi Pay API
- **Формат:** RESTful API с JSON (UTF-8)
- **Протокол:** HTTPS с IPSec VPN туннелем
- **Авторизация:** Bearer token (OAuth)
- **Способы оплаты:**
  - QR-код Kaspi Pay
  - Форма ввода данных карты (номер, дата, CVV) - для карт всех банков РК
  - Apple Pay, Google Pay, Samsung Pay
- **Принимаемые карты:** Visa и MasterCard всех банков Казахстана

### Структура БД (Supabase)
Таблица `participants`:
- `id` (uuid, primary key)
- `full_name` (text, required)
- `phone` (text, required)
- `email` (text, required)
- `city` (text, required)
- `status` (text, default: 'pending') - статус оплаты (pending, paid)
- `payment_id` (text, nullable) - ID транзакции от Kaspi Pay
- `payment_date` (timestamp, nullable) - дата оплаты
- `telegram_user_id` (text, nullable) - ID пользователя в Telegram (если используется бот)
- `invite_link_used` (boolean, default: false) - использована ли одноразовая ссылка
- `created_at` (timestamp)

## Убрано из планов
- ❌ Интеграция с Prodamus (выбрали Kaspi Pay)
- ❌ Интеграция с ePay (слишком много документов)
- ❌ Автоматизация ежедневных рассылок Zoom (делается вручную)
- ❌ AI-ассистент для техподдержки (не требуется)
